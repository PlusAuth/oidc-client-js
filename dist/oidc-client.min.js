!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).PlusAuthOIDCClient={})}(this,function(e){"use strict";let t={USER_LOGOUT:"user_logout",USER_LOGIN:"user_login",SILENT_RENEW_SUCCESS:"silent_renew_success",SILENT_RENEW_ERROR:"silent_renew_error",SESSION_CHANGE:"session_change"};class i extends Error{constructor(e,t){super(`${e}${t&&` - ${t}`||""}`),this.name="OIDCClientError",this.error=e,this.error_description=t}}class s extends i{constructor(e,t,i,s){super(e,t),this.name="AuthenticationError",this.state=i,this.error_uri=s}}class n extends i{constructor(e){super(e),this.name="InvalidJWTError",this.error_description=e}}class o extends n{constructor(e){super(e),this.name="InvalidIdTokenError"}}class r{constructor(e=""){this.prefix=e}}class a extends r{get(e){return new Promise(t=>{let i=window.localStorage.getItem(this.prefix+e);t(i?JSON.parse(i):null)})}set(e,t){return new Promise(i=>{window.localStorage.setItem(this.prefix+e,JSON.stringify(t)),i()})}del(e){return new Promise(t=>{window.localStorage.removeItem(this.prefix+e),t()})}clear(e){return new Promise(t=>{let i;let s=[];for(i=0;i<window.localStorage.length;i++){let n=window.localStorage.key(i);(null==n?void 0:n.substring(0,this.prefix.length))==this.prefix&&s.push(n)}for(i=0;i<s.length;i++)if(e)try{let o=JSON.parse(window.localStorage.getItem(s[i]));o.created_at<e&&window.localStorage.removeItem(s[i])}catch(r){}else window.localStorage.removeItem(s[i]);t()})}constructor(e="pa_oidc."){super(e)}}class l extends r{clear(e){return e?(this.map.forEach((t,i)=>{t.created_at<e&&this.map.delete(i)}),Promise.resolve()):Promise.resolve(this.map.clear())}del(e){return this.map.delete(e),Promise.resolve()}get(e){return Promise.resolve(this.map.get(e)||null)}set(e,t){return this.map.set(e,t),Promise.resolve()}constructor(...e){super(...e),this.map=new Map}}class c{once(e,t){function i(...s){this.off(e,i),t.apply(this,s)}return i.fn=t,this.on(e,i),this}on(e,t){return this.callbacks[`$${e}`]||(this.callbacks[`$${e}`]=[]),this.callbacks[`$${e}`].push(t),this}off(e,t){if(!e)return this.callbacks={},this;let i=this.callbacks[`$${e}`];if(!i)return this;if(!t)return delete this.callbacks[`$${e}`],this;for(let s=0;s<i.length;s++){let n=i[s];if(n===t||n.fn===t){i.splice(s,1);break}}return 0===i.length&&delete this.callbacks[`$${e}`],this}emit(e,...t){let i=this.callbacks[`$${e}`];if(i){i=i.slice(0);for(let s=0,n=i.length;s<n;++s)i[s].apply(this,t)}return this}constructor(){this.callbacks={}}}class h{start(e,t){e<=0&&(e=1);let i=this.now()/1e3+e;if(this._expiration===i&&this._timerHandle)return;this.stop(),this._expiration=i;let s=5;e<5&&(s=e),this._timerHandle=setInterval(()=>{this._expiration<=this.now()/1e3&&(this.stop(),t())},1e3*s)}stop(){this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}constructor(e=()=>Date.now()){this.now=e}}function d(){let e=window.document.createElement("iframe");return e.style.width="0",e.style.height="0",e.style.position="absolute",e.style.visibility="hidden",e.style.display="none",e.title="__pa_helper__hidden",e.ariaHidden="true",e}for(var u,p=function(e){var t=e.default;if("function"==typeof t){var i=function(){return t.apply(this,arguments)};i.prototype=t.prototype}else i={};return Object.defineProperty(i,"__esModule",{value:!0}),Object.keys(e).forEach(function(t){var s=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(i,t,s.get?s:{enumerable:!0,get:function(){return e[t]}})}),i}(Object.freeze({__proto__:null,default:function(e,t){return t=t||{},new Promise(function(i,s){var n=new XMLHttpRequest,o=[],r=[],a={},l=function(){return{ok:2==(n.status/100|0),statusText:n.statusText,status:n.status,url:n.responseURL,text:function(){return Promise.resolve(n.responseText)},json:function(){return Promise.resolve(n.responseText).then(JSON.parse)},blob:function(){return Promise.resolve(new Blob([n.response]))},clone:l,headers:{keys:function(){return o},entries:function(){return r},get:function(e){return a[e.toLowerCase()]},has:function(e){return(e.toLowerCase() in a)}}}};for(var c in n.open(t.method||"get",e,!0),n.onload=function(){n.getAllResponseHeaders().replace(/^(.*?):[^\S\n]*([\s\S]*?)$/gm,function(e,t,i){o.push(t=t.toLowerCase()),r.push([t,i]),a[t]=a[t]?a[t]+","+i:i}),i(l())},n.onerror=s,n.withCredentials="include"==t.credentials,t.headers)n.setRequestHeader(c,t.headers[c]);n.send(t.body||null)})}})),w=self.fetch||(self.fetch=p.default||p),_=[],f="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",m=0,g=f.length;m<g;++m)_[m]=f[m];function y(e,t=!0){if(!e)return"";let i=[];for(let s in e)e.hasOwnProperty(s)&&e[s]&&i.push(`${encodeURIComponent(s)}=${encodeURIComponent("object"==typeof e[s]?JSON.stringify(e[s]):e[s])}`);return`${t?"?":""}${i.join("&")}`}function v(e){let t=null,i=e.headers||{};return i={"Content-Type":"form"===e.requestType?"application/x-www-form-urlencoded;charset=UTF-8":"application/json;charset=UTF-8",...i},e.body&&(t="form"===e.requestType?y(e.body,!1):JSON.stringify(e.body)),new Promise((s,n)=>{w(e.url,{method:e.method,body:t,headers:i}).then(e=>s(e.json())).catch(n)})}let k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";function S(e){let t="",i=k.length,s=256-256%i;for(;e>0;){let n=function(e){let t=self.crypto||self.msCrypto,i=new Uint8Array(e);for(let s=0;s<e;s+=65536)t.getRandomValues(i.subarray(s,s+Math.min(e-s,65536)));return i}(Math.ceil(256*e/s));for(let o=0;o<n.length&&e>0;o++){let r=n[o];r<s&&(t+=k.charAt(r%i),e--)}}return t}let T=e=>decodeURIComponent(atob(e.replace(/_/g,"/").replace(/-/g,"+")).split("").map(e=>`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`).join(""));function b(e){try{let t=e.split(".");if(3!==t.length)throw Error("Wrong JWT format");return{header:JSON.parse(T(t[0])),payload:JSON.parse(T(t[1]))}}catch(i){throw new n("Failed to parse jwt")}}let E=["iss","aud","exp","nbf","iat","jti","azp","nonce","auth_time","at_hash","c_hash","acr","amr","sub_jwk","cnf","sip_from_tag","sip_date","sip_callid","sip_cseq_num","sip_via_branch","orig","dest","mky","events","toe","txn","rph","sid","vot","vtm","attest","origid","act","scope","client_id","may_act","jcard","at_use_nbr"],O=(e,t)=>t&&t.split(/\s+/g).filter(t=>t===e).length>0,I=(e,t)=>t&&t.split(" ").indexOf(e)>-1,x=(e,t=400,i=600)=>{let s=window.screenX+(window.innerWidth-t)/2,n=window.screenY+(window.innerHeight-i)/2;return window.open(e,"oidc-login-popup",`left=${s},top=${n},width=${t},height=${i},resizable,scrollbars=yes,status=1`)},P=`${performance.now()}:${1e9*Math.random()|0}`,$={};class R{CallOnce(e,t,i=3e3){if(!e)throw"empty lockname";if(!window.localStorage){t();return}let s=this.keyPrefix+e;localStorage.setItem(s,P),setTimeout(()=>{localStorage.getItem(s)==P&&t()},150),setTimeout(function(){localStorage.removeItem(s)},i)}BroadcastMessageToAllTabs(e,t){try{$[e](t)}catch(i){}if(!window.localStorage)return;let s={data:t,timeStamp:new Date().getTime()};localStorage.setItem(`${this.keyPrefix}event${e}`,JSON.stringify(s)),setTimeout(()=>{localStorage.removeItem(`${this.keyPrefix}event${e}`)},3e3)}OnBroadcastMessage(e,t){$[e]=t,window.localStorage&&window.addEventListener("storage",i=>{if(i.key!=`${this.keyPrefix}event${e}`||!i.newValue)return;let s=JSON.parse(i.newValue);t(s.data)})}constructor(e){this.keyPrefix=e}}class j extends c{async initialize(e=!0){return this.initialized?this:(this.__initializePromise||(this.__initializePromise=new Promise(async(t,s)=>{try{this.stateStore.init&&await this.stateStore.init(),this.authStore.init&&await this.authStore.init(),this.options.endpoints&&0!==Object.keys(this.options.endpoints).length||await this.fetchFromIssuer(),this.initialized=!0;try{!e||(null==window?void 0:window.frameElement)||await this.silentLogin()}catch(n){await this.authStore.clear()}t(this)}catch(o){s(o instanceof i?o:new i(o.message))}finally{this.__initializePromise=void 0}})),this.__initializePromise)}async login(e={},t={}){window.location.assign(await this.createAuthRequest(e,t))}async loginWithPopup(e={},s={}){let n=await this.createAuthRequest({...e,response_mode:"web_message",display:"popup",request_type:"p"}),{response:o,state:r}=await function(e,t){let s=t.popup;if(s?s.location.href=e:s=x(e),!s)throw Error("Could not open popup");return new Promise((e,n)=>{let o=setTimeout(()=>{n(new i("Timed out"))},t.timeout||6e4);window.addEventListener("message",t=>{if(!t.data||"authorization_response"!==t.data.type)return;clearTimeout(o),s.close();let r=t.data.response||t.data;r.error?n(new i(r.error,r.error_description)):e(t.data)})})}(n,s),{authParams:a,localState:l}=r,c=await this.handleAuthResponse(o,a,l),h=await this.handleTokenResult(c,a,Object.assign({},this.options,a));return h.session_state=o.session_state,this.synchronizer.BroadcastMessageToAllTabs(t.USER_LOGIN,h),l}async loginCallback(e=null==window?void 0:null===(u=window.location)||void 0===u?void 0:u.href){let n;if(!e)return Promise.reject(new i("Url must be passed to handle login redirect"));try{n=new URL(e)}catch(o){return Promise.reject(new i(`Invalid callback url passed: "${e}"`))}let r=function(e){let t={};e=e.trim().replace(/^(\?|#|&)/,"");let i=e.split("&");for(let s=0;s<i.length;s+=1){let n=i[s],o=n.split("="),r=decodeURIComponent(o.shift()),a=o.length>0?o.join("="):"";t[r]=decodeURIComponent(a)}return t}(n.search||n.hash),a=await this.loadState(r.state),{authParams:l,localState:c,request_type:h}=a;switch(e=e||window.location.href,h){case"s":(null==window?void 0:window.frameElement)&&e&&window.parent.postMessage({type:"authorization_response",response:r,state:a},`${location.protocol}//${location.host}`);return;case"p":window.opener&&e&&window.opener.postMessage({type:"authorization_response",response:r,state:a},`${location.protocol}//${location.host}`);return;default:if(r.error)return Promise.reject(new s(r.error,r.error_description));let d=await this.handleAuthResponse(r,l,c),p=await this.handleTokenResult(d,l,Object.assign({},this.options,l));return p.session_state=r.session_state,this.synchronizer.BroadcastMessageToAllTabs(t.USER_LOGIN,p),c}}async logout(e={}){if(!e.localOnly){let t=await this.authStore.get("auth"),i=e.id_token_hint||(null==t?void 0:t.id_token_raw);window.location.assign(await this.createLogoutRequest({...e,id_token_hint:i}))}await this.authStore.clear()}async revokeToken(e,t="access_token",s={}){if(!this.options.endpoints.revocation_endpoint)return Promise.reject(new i('"revocation_endpoint" doesn\'t exist'));let n={client_id:s.client_id||this.options.client_id,client_secret:s.client_secret||this.options.client_secret,token_type_hint:t,token:e};return this.http({method:"POST",requestType:"form",url:this.options.endpoints.revocation_endpoint,body:n})}async silentLogin(e={},n={}){let o;await this.initialize(!1);let r={},a=await this.authStore.get("auth")||{},l=Object.assign({},this.options,e);if(l.silent_redirect_uri&&(l.redirect_uri=l.silent_redirect_uri),this.options.useRefreshToken&&(null==a?void 0:a.refresh_token))r.authParams=Object.assign({},(null==a?void 0:a.authParams)||{},r.authParams||{}),o=await this.exchangeRefreshToken({...l,refresh_token:a.refresh_token});else{var c;let h=await this.createAuthRequest({...l,display:"page",response_mode:"query",prompt:l.prompt||"none",request_type:"s"},n),{response:u,state:p}=await (c={timeout:l.silentRequestTimeout,eventOrigin:window.location.origin},new Promise((e,t)=>{let n=null,o=d(),r=setTimeout(()=>{t(new i("Timed out")),l()},1e3*(c.timeout||10)),a=i=>{if(i.origin!=c.eventOrigin||!i.data||"authorization_response"!==i.data.type)return;let n=i.source;n&&n.close();let o=i.data.response||i.data;o.error?t(new s(o.error,o.error_description,o.state,o.error_uri)):e(i.data),clearTimeout(r),l()},l=()=>{null!=n&&clearTimeout(n),window.document.body.contains(o)&&window.document.body.removeChild(o),window.removeEventListener("message",a,!1)},u=()=>setTimeout(()=>{t(new i("Could not complete silent authentication",h)),l()},300);window.addEventListener("message",a,!1),window.document.body.appendChild(o),o.setAttribute("src",h),o.onload=function(){n=u()}}));o=await this.handleAuthResponse(u,l,n),a.session_state=u.session_state,r=p}let w=await this.handleTokenResult(o,r.authParams,l);return w.session_state=a.session_state,this.synchronizer.BroadcastMessageToAllTabs(t.USER_LOGIN,w),r.localState}async getAccessToken(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.access_token}async getRefreshToken(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.refresh_token}async getIdToken(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.id_token}async getIdTokenRaw(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.id_token_raw}async getScopes(){var e,t;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:null===(t=e.scope)||void 0===t?void 0:t.split(" ")}async getUser(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.user}async isLoggedIn(e=!1){let t=!!await this.getUser();if(!t&&!e)try{return await this.silentLogin(),!0}catch(i){return!1}return t}async createAuthRequest(e={},t={}){var s,n;(null===(s=this.options.endpoints)||void 0===s?void 0:s.authorization_endpoint)||await this.initialize(!1);let o=Object.assign({},this.options,e);t.code_verifier=S(72);let r={client_id:o.client_id,state:S(10),scope:o.scope,audience:o.audience,redirect_uri:o.redirect_uri,response_type:o.response_type||"code",ui_locales:o.ui_locales,prompt:o.prompt,display:o.display,claims:o.claims,claims_locales:o.claims_locales,acr_values:o.acr_values,registration:o.registration,login_hint:o.login_hint,id_token_hint:o.id_token_hint,web_message_uri:o.web_message_uri,web_message_target:o.web_message_target,...o.extraParams&&o.extraParams};(O("id_token",r.response_type)||I("openid",r.scope))&&(r.nonce=S(10)),O("code",r.response_type)&&(r.code_challenge=await ((n=t.code_verifier).length<43||n.length>128?Promise.reject(new i(`Invalid code length: ${n.length}`)):new Promise((e,t)=>{crypto.subtle.digest("SHA-256",new TextEncoder().encode(n)).then(t=>e(function(e){let t=function(e){for(var t,i=e.length,s=i%3,n=[],o=0,r=i-s;o<r;o+=16383)n.push(function(e,t,i){for(var s,n=[],o=t;o<i;o+=3)n.push(_[(s=(e[o]<<16&16711680)+(e[o+1]<<8&65280)+(255&e[o+2]))>>18&63]+_[s>>12&63]+_[s>>6&63]+_[63&s]);return n.join("")}(e,o,o+16383>r?r:o+16383));return 1===s?n.push(_[(t=e[i-1])>>2]+_[t<<4&63]+"=="):2===s&&n.push(_[(t=(e[i-2]<<8)+e[i-1])>>10]+_[t>>4&63]+_[t<<2&63]+"="),n.join("")}(new Uint8Array(e));return t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}(new Uint8Array(t))),function(e){return t(e)})})),r.code_challenge_method=o.code_challenge_method||"S256");let a=this.options.currentTimeInMillis&&this.options.currentTimeInMillis()||Date.now(),l=o.fragment?`#${o.fragment}`:"",c=y(r),h=`${this.options.endpoints.authorization_endpoint}${c}${l}`;return this.stateStore.clear(a-864e5),await this.stateStore.set(r.state,{created_at:a,authParams:r,localState:t,request_type:o.request_type}),h}async createLogoutRequest(e={}){var t;(null===(t=this.options.endpoints)||void 0===t?void 0:t.end_session_endpoint)||await this.fetchFromIssuer();let i=Object.assign({},this.options,e),s={id_token_hint:i.id_token_hint,post_logout_redirect_uri:i.post_logout_redirect_uri,...i.extraLogoutParams&&i.extraLogoutParams};return`${this.options.endpoints.end_session_endpoint}${y(s)}`}async exchangeAuthorizationCode(e){var t;(null===(t=this.options.endpoints)||void 0===t?void 0:t.token_endpoint)||await this.fetchFromIssuer();let i=e.extraTokenHeaders;return(delete(e=Object.assign({},e,e.extraTokenParams||{})).extraTokenParams,delete e.extraTokenHeaders,e.grant_type=e.grant_type||"authorization_code",e.client_id=e.client_id||this.options.client_id,e.redirect_uri=e.redirect_uri||this.options.redirect_uri,e.code)?e.redirect_uri?e.code_verifier?e.client_id?this.http({url:`${this.options.endpoints.token_endpoint}`,method:"POST",requestType:"form",body:e,headers:i}):Promise.reject(Error('"client_id" is required')):Promise.reject(Error('"code_verifier" is required')):Promise.reject(Error('"redirect_uri" is required')):Promise.reject(Error('"code" is required'))}async exchangeRefreshToken(e){var t;(null===(t=this.options.endpoints)||void 0===t?void 0:t.token_endpoint)||await this.fetchFromIssuer();let i=e.extraTokenHeaders;return((e=Object.assign({},e,e.extraTokenParams||{})).grant_type=e.grant_type||"refresh_token",e.client_id=e.client_id||this.options.client_id,e.client_secret=e.client_secret||this.options.client_secret,e.refresh_token)?e.client_id?this.http({url:`${this.options.endpoints.token_endpoint}`,method:"POST",requestType:"form",body:e,headers:i}):Promise.reject(Error('"client_id" is required')):Promise.reject(Error('"refresh_token" is required'))}async fetchFromIssuer(){try{let e=`${this.options.issuer}/.well-known/openid-configuration`,t=await this.http({url:e,method:"GET",requestType:"json"});this.issuer_metadata=t;let s={};for(let n of Object.keys(this.issuer_metadata))(n.endsWith("_endpoint")||n.indexOf("_session")>-1||n.indexOf("_uri")>-1)&&(s[n]=this.issuer_metadata[n]);return this.options.endpoints=s,this.issuer_metadata}catch(o){throw new i("Loading metadata failed",o.message)}}async handleAuthResponse(e,t,i={}){return e.code?this.exchangeAuthorizationCode({redirect_uri:t.redirect_uri,client_id:t.client_id,code_verifier:i.code_verifier,grant_type:"authorization_code",code:e.code}):e}async handleTokenResult(e,t,r){let a;await this.initialize(!1);let l={};if(e.error)throw new s(e.error,e.error_description);if(e.id_token){if(a=await function(e,t,s){if(!t)throw new i("No nonce on state");try{let r=b(e);if(t!==r.payload.nonce)throw Error(`Invalid nonce in id_token: ${r.payload.nonce}`);if(function(e,t,i=!1){let{clockSkew:s,currentTimeInMillis:o,issuer:r,audience:a,client_id:l}=t;s||(s=0);let c=(o&&o()||Date.now())/1e3,h=b(e).payload;if(!h.iss)throw new n("Issuer (iss) was not provided");if(h.iss!==r)throw new n(`Invalid Issuer (iss) in token: ${h.iss}`);if(!h.aud)throw new n("Audience (aud) was not provided");if(Array.isArray(h.aud)?-1==h.aud.indexOf(i?l:a||l):h.aud!==(i?l:a||l))throw new n(`Invalid Audience (aud) in token: ${h.aud}`);if(h.azp&&h.azp!==l)throw new n(`Invalid Authorized Party (azp) in token: ${h.azp}`);let d=Math.ceil(c+s),u=Math.floor(c-s);if(!h.iat)throw new n("Issued At (iat) was not provided");if(d<h.iat)throw new n(`Issued At (iat) is in the future: ${h.iat}`);if(h.nbf&&d<h.nbf)throw new n(`Not Before time (nbf) is in the future: ${h.nbf}`);if(!h.exp)throw new n("Expiration Time (exp) was not provided");if(h.exp<u)throw new n(`Expiration Time (exp) is in the past: ${h.exp}`)}(e,s,!0),!r.payload.sub)throw Error("No Subject (sub) present in id_token");return r.payload}catch(a){throw new o(a.message)}}(e.id_token,t.nonce,r),r.idTokenValidator&&!await r.idTokenValidator(e.id_token))return Promise.reject(new o("Id Token validation failed"));Object.keys(a).forEach(e=>{E.includes(e)||(l[e]=a[e])})}if(e.access_token){var c;if(r.requestUserInfo&&(null===(c=this.options.endpoints)||void 0===c?void 0:c.userinfo_endpoint)){let h=await this.fetchUserInfo(e.access_token);h.error||(l={...l,...h})}}return{authParams:t,user:l,...e,id_token:a,id_token_raw:e.id_token,scope:e.scope||t.scope}}async loadState(e){let t=await this.stateStore.get(e);return t?(await this.stateStore.del(e),t):Promise.reject(new s("State not found"))}async fetchUserInfo(e){return this.http({method:"GET",url:`${this.options.endpoints.userinfo_endpoint}`,requestType:"json",headers:{Authorization:`Bearer ${e}`}})}monitorSession({sub:e,session_state:i}){let{client_id:s,endpoints:n}=this.options;if(!(null==n?void 0:n.check_session_iframe)){console.warn('"check_session_iframe" endpoint missing or session management is not supported by provider');return}if(!this.sessionCheckerFrame){let o=async i=>{if(i)this.emit(t.USER_LOGOUT);else{this.emit(t.SESSION_CHANGE);try{await this.silentLogin({},{});let s=await this.authStore.get("auth");s?(null==s?void 0:s.user.sub)===e&&this.sessionCheckerFrame.start(s.session_state):this.emit(t.USER_LOGOUT,null)}catch(n){this.emit(t.USER_LOGOUT);return}}};this.sessionCheckerFrame=function(e){let t,i;let{url:s,callback:n,client_id:o,checkInterval:r}=e,a=s.indexOf("/",s.indexOf("//")+2),l=s.substr(0,a),c=d(),h=()=>new Promise(e=>{window.document.body.appendChild(c),window.addEventListener("message",w,!1),c.onload=()=>{e(null)}}),u=e=>{h().then(()=>{if(e&&t!==e){p(),t=e;let s=()=>{c.contentWindow.postMessage(`${o} ${t}`,l)};s(),i=window.setInterval(s,r||2e3)}})},p=()=>{t=null,i&&(window.clearInterval(i),i=null)},w=e=>{e.origin===l&&e.source===c.contentWindow&&("error"===e.data?(p(),n(e.data)):"changed"===e.data&&(p(),n()))};return c.setAttribute("src",s),{stop:p,start:u}}({url:n.check_session_iframe,client_id:s,callback:o,checkInterval:this.options.checkSessionInterval})}this.sessionCheckerFrame.start(i)}async onUserLogin(e){let{expires_in:i,user:s,scope:n,access_token:o,id_token:r,refresh_token:a,session_state:l,id_token_raw:c}=e;if(await this.authStore.set("auth",e),this.user=s,this.scopes=null==n?void 0:n.split(" "),this.accessToken=o,this.idToken=r,this.idTokenRaw=c,this.refreshToken=a,this.emit(t.USER_LOGIN,e),!(null==window?void 0:window.frameElement)&&(this.options.checkSession&&this.monitorSession({sub:s.sub||s.id,session_state:l}),void 0!==i&&this.options.autoSilentRenew)){let h=Number(i)-this.options.secondsToRefreshAccessTokenBeforeExp;h>=0&&this._accessTokenExpireTimer.start(h,async()=>{this.synchronizer.CallOnce("silent-login",async()=>{try{await this.silentLogin(),this.emit(t.SILENT_RENEW_SUCCESS,null)}catch(e){this.emit(t.SILENT_RENEW_ERROR,e)}})})}}constructor(e){if(super(),!function(e){try{let t=new URL(e);if(!["http:","https:"].includes(t.protocol)||""!==t.search||""!==t.hash)return!1;return!0}catch(i){return!1}}(e.issuer))throw new i('"issuer" must be a valid uri.');this.synchronizer=new R(btoa(e.issuer)),this.options=Object.assign({secondsToRefreshAccessTokenBeforeExp:60,autoSilentRenew:!0,checkSession:!0},e,{issuer:e.issuer.endsWith("/")?e.issuer.slice(0,-1):e.issuer}),this.http=this.options.httpClient||v,this.stateStore=this.options.stateStore||new a("pa_oidc.state."),this.authStore=this.options.authStore||new l,this.options.autoSilentRenew&&(this._accessTokenExpireTimer=new h),this.on(t.USER_LOGOUT,async()=>{this.user=void 0,this.scopes=void 0,this.accessToken=void 0,this.idToken=void 0,this.refreshToken=void 0,await this.authStore.clear()}),this.synchronizer.OnBroadcastMessage(t.USER_LOGIN,this.onUserLogin.bind(this))}}e.AuthenticationError=s,e.EventEmitter=c,e.Events=t,e.InMemoryStateStore=l,e.InvalidIdTokenError=o,e.InvalidJWTError=n,e.LocalStorageStateStore=a,e.OIDCClient=j,e.OIDCClientError=i,e.StateStore=r,e.default=function(e){return new j(e).initialize()},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=oidc-client.min.js.map
