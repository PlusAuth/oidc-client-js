!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).PlusAuthOIDCClient={})}(this,function(e){"use strict";let t={USER_LOGOUT:"user_logout",USER_LOGIN:"user_login",SILENT_RENEW_SUCCESS:"silent_renew_success",SILENT_RENEW_ERROR:"silent_renew_error",SESSION_CHANGE:"session_change"};function i(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class o extends Error{constructor(e,t){super(`${e}${t&&` - ${t}`||""}`),i(this,"error",void 0),i(this,"error_description",void 0),this.name="OIDCClientError",this.error=e,this.error_description=t}}class n extends o{constructor(e,t,o,n){super(e,t),i(this,"state",void 0),i(this,"error_uri",void 0),this.name="AuthenticationError",this.state=o,this.error_uri=n}}class s extends n{constructor(e,t){super(e),i(this,"state",void 0),this.name="StateNotFound",this.state=t}}class r extends o{constructor(e){super(e),this.name="InvalidJWTError",this.error_description=e}}class a extends r{constructor(e){super(e),this.name="InvalidIdTokenError"}}class l extends o{constructor(e){super(e),this.name="InteractionCancelled"}}class h{constructor(e=""){var t,i;i=void 0,(t="prefix")in this?Object.defineProperty(this,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[t]=i,this.prefix=e}}class c extends h{get(e){return new Promise(t=>{let i=window.localStorage.getItem(this.prefix+e);t(i?JSON.parse(i):null)})}set(e,t){return new Promise(i=>{window.localStorage.setItem(this.prefix+e,JSON.stringify(t)),i()})}del(e){return new Promise(t=>{window.localStorage.removeItem(this.prefix+e),t()})}clear(e){return new Promise(t=>{let i;let o=[];for(i=0;i<window.localStorage.length;i++){let e=window.localStorage.key(i);(null==e?void 0:e.substring(0,this.prefix.length))===this.prefix&&o.push(e)}for(i=0;i<o.length;i++)if(e)try{JSON.parse(window.localStorage.getItem(o[i])).created_at<e&&window.localStorage.removeItem(o[i])}catch(e){}else window.localStorage.removeItem(o[i]);t()})}constructor(e="pa_oidc."){super(e)}}class d extends h{clear(e){return e?(this.map.forEach((t,i)=>{t.created_at<e&&this.map.delete(i)}),Promise.resolve()):Promise.resolve(this.map.clear())}del(e){return this.map.delete(e),Promise.resolve()}get(e){return Promise.resolve(this.map.get(e)||null)}set(e,t){return this.map.set(e,t),Promise.resolve()}constructor(...e){var t;super(...e),t=new Map,"map"in this?Object.defineProperty(this,"map",{value:t,enumerable:!0,configurable:!0,writable:!0}):this.map=t}}class u{once(e,t){function i(...o){this.off(e,i),t.apply(this,o)}return i.fn=t,this.on(e,i),this}on(e,t){return this.callbacks[`$${e}`]||(this.callbacks[`$${e}`]=[]),this.callbacks[`$${e}`].push(t),this}off(e,t){if(!e)return this.callbacks={},this;let i=this.callbacks[`$${e}`];if(!i)return this;if(!t)return delete this.callbacks[`$${e}`],this;for(let e=0;e<i.length;e++){let o=i[e];if(o===t||o.fn===t){i.splice(e,1);break}}return 0===i.length&&delete this.callbacks[`$${e}`],this}emit(e,...t){let i=this.callbacks[`$${e}`];if(i){i=i.slice(0);for(let e=0,o=i.length;e<o;++e)i[e].apply(this,t)}return this}constructor(){var e,t;t=void 0,(e="callbacks")in this?Object.defineProperty(this,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):this[e]=t,this.callbacks={}}}function p(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class f{start(e,t){e<=0&&(e=1);let i=this.now()/1e3+e;if(this._expiration===i&&this._timerHandle)return;this.stop(),this._expiration=i;let o=5;e<5&&(o=e),this._timerHandle=setInterval(()=>{this._expiration<=this.now()/1e3&&(this.stop(),t())},1e3*o)}stop(){this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}constructor(e=()=>Date.now()){p(this,"now",void 0),p(this,"_timerHandle",void 0),p(this,"_expiration",void 0),this.now=e}}function w(){let e=window.document.createElement("iframe");return e.style.width="0",e.style.height="0",e.style.position="absolute",e.style.visibility="hidden",e.style.display="none",e.title="__pa_helper__hidden",e.ariaHidden="true",e}var _,m,v,g={},y=function(){if(v)return g;v=1,g.byteLength=function(e){var t=r(e),i=t[0],o=t[1];return(i+o)*3/4-o},g.toByteArray=function(e){var o,n,s=r(e),a=s[0],l=s[1],h=new i((a+l)*3/4-l),c=0,d=l>0?a-4:a;for(n=0;n<d;n+=4)o=t[e.charCodeAt(n)]<<18|t[e.charCodeAt(n+1)]<<12|t[e.charCodeAt(n+2)]<<6|t[e.charCodeAt(n+3)],h[c++]=o>>16&255,h[c++]=o>>8&255,h[c++]=255&o;return 2===l&&(o=t[e.charCodeAt(n)]<<2|t[e.charCodeAt(n+1)]>>4,h[c++]=255&o),1===l&&(o=t[e.charCodeAt(n)]<<10|t[e.charCodeAt(n+1)]<<4|t[e.charCodeAt(n+2)]>>2,h[c++]=o>>8&255,h[c++]=255&o),h},g.fromByteArray=function(t){for(var i,o=t.length,n=o%3,s=[],r=0,a=o-n;r<a;r+=16383)s.push(function(t,i,o){for(var n,s=[],r=i;r<o;r+=3)s.push(e[(n=(t[r]<<16&0xff0000)+(t[r+1]<<8&65280)+(255&t[r+2]))>>18&63]+e[n>>12&63]+e[n>>6&63]+e[63&n]);return s.join("")}(t,r,r+16383>a?a:r+16383));return 1===n?s.push(e[(i=t[o-1])>>2]+e[i<<4&63]+"=="):2===n&&s.push(e[(i=(t[o-2]<<8)+t[o-1])>>10]+e[i>>4&63]+e[i<<2&63]+"="),s.join("")};for(var e=[],t=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",n=0,s=o.length;n<s;++n)e[n]=o[n],t[o.charCodeAt(n)]=n;function r(e){var t=e.length;if(t%4>0)throw Error("Invalid string. Length must be a multiple of 4");var i=e.indexOf("=");-1===i&&(i=t);var o=i===t?0:4-i%4;return[i,o]}return t["-".charCodeAt(0)]=62,t["_".charCodeAt(0)]=63,g}();function S(e,t=!0){if(!e)return"";let i=[];for(let t in e)e.hasOwnProperty(t)&&e[t]&&i.push(`${encodeURIComponent(t)}=${encodeURIComponent("object"==typeof e[t]?JSON.stringify(e[t]):e[t])}`);return`${t?"?":""}${i.join("&")}`}function k(e){return("string"==typeof e?e:y.fromByteArray(new Uint8Array(e))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function b(e){let t=null,i=e.headers||{};return"POST"===e.method&&(i={"Content-Type":"form"===e.requestType?"application/x-www-form-urlencoded;charset=UTF-8":"application/json;charset=UTF-8",...i}),e.body&&(t="form"===e.requestType?S(e.body,!1):JSON.stringify(e.body)),new Promise((o,n)=>{fetch(e.url,{method:e.method,body:t,headers:i}).then(e=>o(e.json())).catch(n)})}async function T(e){return void 0!==window.crypto&&"subtle"in window.crypto?k(new Uint8Array(await window.crypto.subtle.digest("SHA-256",new TextEncoder().encode(e)))):k(function(e,t=!0){let i,o;function n(e,t){return e>>>t|e<<32-t}let s=Math.pow,r=s(2,32),a="length",l="",h=[],c=8*e[a],d=T.h=T.h||[],u=T.k=T.k||[],p=u[a],f={};for(let e=2;p<64;e++)if(!f[e]){for(i=0;i<313;i+=e)f[i]=e;d[p]=s(e,.5)*r|0,u[p++]=s(e,1/3)*r|0}for(e+="\x80";e[a]%64-56;)e+="\0";for(i=0;i<e[a];i++){if((o=e.charCodeAt(i))>>8)return;h[i>>2]|=o<<(3-i)%4*8}for(o=0,h[h[a]]=c/r|0,h[h[a]]=c;o<h[a];){let e=h.slice(o,o+=16),t=d;for(i=0,d=d.slice(0,8);i<64;i++){let t=e[i-15],o=e[i-2],s=d[0],r=d[4],a=d[7]+(n(r,6)^n(r,11)^n(r,25))+(r&d[5]^~r&d[6])+u[i]+(e[i]=i<16?e[i]:e[i-16]+(n(t,7)^n(t,18)^t>>>3)+e[i-7]+(n(o,17)^n(o,19)^o>>>10)|0);(d=[a+((n(s,2)^n(s,13)^n(s,22))+(s&d[1]^s&d[2]^d[1]&d[2]))|0].concat(d))[4]=d[4]+a|0}for(i=0;i<8;i++)d[i]=d[i]+t[i]|0}for(i=0;i<8;i++)for(o=3;o+1;o--){let e=d[i]>>8*o&255;l+=(e<16?0:"")+e.toString(16)}return t?btoa(l.match(/\w{2}/g).map(e=>String.fromCharCode(Number.parseInt(e,16))).join("")):l}(e))}let E="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";function I(e){let t="",i=E.length,o=256-256%i;for(;e>0;){let n=function(e){let t=self.crypto||self.msCrypto,i=new Uint8Array(e);for(let o=0;o<e;o+=65536)t.getRandomValues(i.subarray(o,o+Math.min(e-o,65536)));return i}(Math.ceil(256*e/o));for(let s=0;s<n.length&&e>0;s++){let r=n[s];r<o&&(t+=E.charAt(r%i),e--)}}return t}async function O(e){return e.length<43||e.length>128?Promise.reject(new o(`Invalid code length: ${e.length}`)):await T(e)}let x=e=>decodeURIComponent(atob(e.replace(/_/g,"/").replace(/-/g,"+")).split("").map(e=>`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`).join(""));function $(e){try{let t=e.split(".");if(3!==t.length)throw Error("Wrong JWT format");return{header:JSON.parse(x(t[0])),payload:JSON.parse(x(t[1]))}}catch(e){throw new r("Failed to parse jwt")}}let R=["iss","aud","exp","nbf","iat","jti","azp","nonce","auth_time","at_hash","c_hash","acr","amr","sub_jwk","cnf","sip_from_tag","sip_date","sip_callid","sip_cseq_num","sip_via_branch","orig","dest","mky","events","toe","txn","rph","sid","vot","vtm","attest","origid","act","scope","client_id","may_act","jcard","at_use_nbr"];function A(...e){return e.reduce((e,t)=>(function e(t,i){for(let o in i)void 0!==i[o]&&("object"==typeof i[o]&&"Object"===i[o].constructor.name?t[o]=e(t[o]||{},i[o]):t[o]=i[o]);return t})(e||{},t),{})}let P=(e,t)=>t&&t.split(/\s+/g).filter(t=>t===e).length>0,C=(e,t)=>t&&t.split(" ").indexOf(e)>-1,L=(e,t=400,i=600)=>{let o=window.screenX+(window.innerWidth-t)/2,n=window.screenY+(window.innerHeight-i)/2;return window.open(e,"oidc-login-popup",`left=${o},top=${n},width=${t},height=${i},resizable,scrollbars=yes,status=1`)};function N(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}let U=`${performance.now()}:${1e9*Math.random()|0}`,j={};class z{CallOnce(e,t,i=3e3){if(!e)throw"empty lockname";if(!window.localStorage){t();return}let o=this.keyPrefix+e;localStorage.setItem(o,U),setTimeout(()=>{localStorage.getItem(o)===U&&t()},150),setTimeout(()=>{localStorage.removeItem(o)},i)}BroadcastMessageToAllTabs(e,t){try{j[e](t)}catch(e){}if(!window.localStorage){this.events.emit(e,t);return}let i={data:t,timeStamp:new Date().getTime()};localStorage.setItem(`${this.keyPrefix}event${e}`,JSON.stringify(i)),setTimeout(()=>{localStorage.removeItem(`${this.keyPrefix}event${e}`)},3e3)}OnBroadcastMessage(e,t){if(j[e]=t,!window.localStorage){this.events.on(e,t);return}window.addEventListener("storage",i=>{i.key===`${this.keyPrefix}event${e}`&&i.newValue&&t(JSON.parse(i.newValue).data)})}constructor(e,t){N(this,"keyPrefix",void 0),N(this,"events",void 0),this.keyPrefix=e,this.events=t}}function q(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class M extends u{async initialize(e=!0){return this.initialized?this:(this.__initializePromise||(this.__initializePromise=new Promise(async(i,n)=>{try{if(this.stateStore.init&&await this.stateStore.init(),this.authStore.init&&await this.authStore.init(),this.options.endpoints&&0!==Object.keys(this.options.endpoints).length||await this.fetchFromIssuer(),this.initialized=!0,e)try{var s;(null===(s=window)||void 0===s?void 0:s.frameElement)||await this.silentLogin()}catch(e){this.emit(t.SILENT_RENEW_ERROR,e),await this.authStore.clear()}else{let e=await this.authStore.get("auth");e&&await this.onUserLogin(e,!0)}i(this)}catch(e){n(e instanceof o?e:new o(e.message))}finally{this.__initializePromise=void 0}})),this.__initializePromise)}async login(e={},t={}){window.location.assign(await this.createAuthRequest(e,t))}async loginWithPopup(e={},i={}){let n=await this.createAuthRequest({response_mode:"fragment",...e,display:"popup",request_type:"p"}),{response:s,state:r}=await function(e,t){let i,n,s=t.popup;if(s?s.location.href=e:s=L(e),!s)throw Error("Could not open popup");return new Promise((e,r)=>{function a(){clearInterval(n),clearTimeout(i),window.removeEventListener("message",h)}function h(t){if(!t.data||"authorization_response"!==t.data.type)return;a(),s.close();let i=t.data.response||t.data;i.error?r(new o(i.error,i.error_description)):e(t.data)}i=setTimeout(()=>{a(),r(new o("Timed out"))},t.timeout||6e4),n=setInterval(()=>{s.closed&&(a(),r(new l("user closed popup")))},300),window.addEventListener("message",h)})}(n,i),{authParams:a,localState:h}=r&&"string"!=typeof r?r:await this.loadState(r||s.state),c=await this.handleAuthResponse(s,a,h),d=await this.handleTokenResult(c,a,A(this.options,a));return d.session_state=s.session_state,this.synchronizer.BroadcastMessageToAllTabs(t.USER_LOGIN,d),h}async loginCallback(e=null===(m=window)||void 0===m?void 0:null===(_=m.location)||void 0===_?void 0:_.href){let i;if(!e)return Promise.reject(new o("Url must be passed to handle login redirect"));try{i=new URL(e)}catch(t){return Promise.reject(new o(`Invalid callback url passed: "${e}"`))}let s=function(e){let t={},i=(e=e.trim().replace(/^(\?|#|&)/,"")).split("&");for(let e=0;e<i.length;e+=1){let o=i[e].split("="),n=decodeURIComponent(o.shift()),s=o.length>0?o.join("="):"";t[n]=decodeURIComponent(s)}return t}(i.search||i.hash),r=await this.loadState(s.state),{authParams:a,localState:l,request_type:h}=r;switch(e=e||window.location.href,h){case"s":var c;(null===(c=window)||void 0===c?void 0:c.frameElement)&&e&&window.parent.postMessage({type:"authorization_response",response:s,state:r},`${location.protocol}//${location.host}`);return;case"p":window.opener&&e&&window.opener.postMessage({type:"authorization_response",response:s,state:r},`${location.protocol}//${location.host}`);return;default:{if(s.error)return Promise.reject(new n(s.error,s.error_description));let e=await this.handleAuthResponse(s,a,l),i=await this.handleTokenResult(e,a,A(this.options,a));return i.session_state=s.session_state,this.synchronizer.BroadcastMessageToAllTabs(t.USER_LOGIN,i),l}}}async logout(e={}){if(!e.localOnly){let t=await this.authStore.get("auth"),i=e.id_token_hint||(null==t?void 0:t.id_token_raw);window.location.assign(await this.createLogoutRequest({...e,id_token_hint:i}))}await this.authStore.clear()}async revokeToken(e,t="access_token",i={}){if(!this.options.endpoints.revocation_endpoint)return Promise.reject(new o('"revocation_endpoint" doesn\'t exist'));let n={client_id:i.client_id||this.options.client_id,client_secret:i.client_secret||this.options.client_secret,token_type_hint:t,token:e};return this.http({method:"POST",requestType:"form",url:this.options.endpoints.revocation_endpoint,body:n})}async silentLogin(e={},i={}){let s;await this.initialize(!1);let r={},a=await this.authStore.get("auth")||{},l=A({response_mode:"query",display:"page",prompt:"none"},this.options,e);if(l.silent_redirect_uri&&(l.redirect_uri=l.silent_redirect_uri),this.options.useRefreshToken&&(null==a?void 0:a.refresh_token))r.authParams=A((null==a?void 0:a.authParams)||{},r.authParams||{}),s=await this.exchangeRefreshToken({...l,refresh_token:a.refresh_token});else{var h;let e=await this.createAuthRequest({...l,request_type:"s"},i),{response:t,state:c}=await (h={timeout:l.silentRequestTimeout,eventOrigin:window.location.origin},new Promise((t,i)=>{let s=null,r=w(),a=setTimeout(()=>{i(new o("Timed out")),c()},1e3*(h.timeout||10)),l=e=>{if(e.origin!==h.eventOrigin||!e.data||"authorization_response"!==e.data.type)return;let o=e.source;o&&o.close();let s=e.data.response||e.data;s.error?i(new n(s.error,s.error_description,s.state,s.error_uri)):t(e.data),clearTimeout(a),c()},c=()=>{null!=s&&clearTimeout(s),window.document.body.contains(r)&&window.document.body.removeChild(r),window.removeEventListener("message",l,!1)},d=()=>setTimeout(()=>{i(new o("Could not complete silent authentication",e)),c()},300);window.addEventListener("message",l,!1),window.document.body.appendChild(r),r.setAttribute("src",e),r.onload=()=>{s=d()}}));s=await this.handleAuthResponse(t,l,i),a.session_state=t.session_state,r=c}let c=await this.handleTokenResult(s,r.authParams,l);return c.session_state=a.session_state,this.synchronizer.BroadcastMessageToAllTabs(t.USER_LOGIN,c),r.localState}async getAccessToken(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.access_token}async getRefreshToken(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.refresh_token}async getIdToken(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.id_token}async getExpiresIn(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.expires_in}async getIdTokenRaw(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.id_token_raw}async getScopes(){var e,t;return null===(t=await this.authStore.get("auth"))||void 0===t?void 0:null===(e=t.scope)||void 0===e?void 0:e.split(" ")}async getUser(){var e;return null===(e=await this.authStore.get("auth"))||void 0===e?void 0:e.user}async isLoggedIn(e=!1){let t=!!await this.getUser();if(!t&&!e)try{return await this.silentLogin(),!0}catch(e){return!1}return t}async createAuthRequest(e={},t={}){var i,o,n;(null===(i=this.options.endpoints)||void 0===i?void 0:i.authorization_endpoint)||await this.initialize(!1);let s=Object.assign({},this.options,e);t.code_verifier=I(72);let r={client_id:s.client_id,state:I(s.stateLength),scope:s.scope,audience:s.audience,redirect_uri:s.redirect_uri,response_mode:s.response_mode,response_type:s.response_type||"code",ui_locales:s.ui_locales,prompt:s.prompt,display:s.display,claims:s.claims,claims_locales:s.claims_locales,acr_values:s.acr_values,registration:s.registration,login_hint:s.login_hint,id_token_hint:s.id_token_hint,web_message_uri:s.web_message_uri,web_message_target:s.web_message_target,...s.extraParams&&s.extraParams};(P("id_token",r.response_type)||C("openid",r.scope))&&(r.nonce=I(s.nonceLength)),P("code",r.response_type)&&(r.code_challenge=await O(t.code_verifier),r.code_challenge_method=s.code_challenge_method||"S256");let a=(null===(o=(n=this.options).currentTimeInMillis)||void 0===o?void 0:o.call(n))||Date.now(),l=s.fragment?`#${s.fragment}`:"",h=S(r),c=`${this.options.endpoints.authorization_endpoint}${h}${l}`;return this.stateStore.clear(a-864e5),await this.stateStore.set(r.state,JSON.parse(JSON.stringify({created_at:a,authParams:r,localState:t,request_type:s.request_type}))),c}async createLogoutRequest(e={}){var t;(null===(t=this.options.endpoints)||void 0===t?void 0:t.end_session_endpoint)||await this.fetchFromIssuer();let i=A(this.options,e),o={id_token_hint:i.id_token_hint,post_logout_redirect_uri:i.post_logout_redirect_uri,...i.extraLogoutParams||{}};return`${this.options.endpoints.end_session_endpoint}${S(o)}`}async exchangeAuthorizationCode(e){var t;(null===(t=this.options.endpoints)||void 0===t?void 0:t.token_endpoint)||await this.fetchFromIssuer();let{extraTokenHeaders:i,extraTokenParams:o,...n}=A(this.options,e),s={...n,...o||{},grant_type:"authorization_code"};for(let e of["code","redirect_uri","code_verifier","client_id"])if(!s[e])return Promise.reject(Error(`"${e}" is required`));return this.http({url:`${this.options.endpoints.token_endpoint}`,method:"POST",requestType:"form",body:s,headers:i})}async exchangeRefreshToken(e){var t;(null===(t=this.options.endpoints)||void 0===t?void 0:t.token_endpoint)||await this.fetchFromIssuer();let{extraTokenHeaders:i,extraTokenParams:o,...n}=e,s={grant_type:"refresh_token",client_id:this.options.client_id,client_secret:this.options.client_secret,...n,...o||{}};for(let e of["refresh_token","client_id"])if(!s[e])return Promise.reject(Error(`"${e}" is required`));return this.http({url:`${this.options.endpoints.token_endpoint}`,method:"POST",requestType:"form",body:s,headers:i})}async fetchFromIssuer(){try{let e=`${this.options.issuer}/.well-known/openid-configuration`,t=await this.http({url:e,method:"GET",requestType:"json"});this.issuer_metadata=t;let i={};for(let e of Object.keys(this.issuer_metadata))(e.endsWith("_endpoint")||e.indexOf("_session")>-1||e.indexOf("_uri")>-1)&&(i[e]=this.issuer_metadata[e]);return this.options.endpoints=i,this.issuer_metadata}catch(e){throw new o("Loading metadata failed",e.message)}}async handleAuthResponse(e,t,i={}){return e.code?this.exchangeAuthorizationCode({redirect_uri:t.redirect_uri,client_id:t.client_id,code_verifier:i.code_verifier,grant_type:"authorization_code",code:e.code}):e}async handleTokenResult(e,t,i){let s;await this.initialize(!1);let l={};if(e.error)throw new n(e.error,e.error_description);if(e.id_token){if(s=await function(e,t,i){if(!t)throw new o("No nonce on state");try{let o=$(e);if(t!==o.payload.nonce)throw Error(`Invalid nonce in id_token: ${o.payload.nonce}`);if(function(e,t,i=!1){let{clockSkew:o,currentTimeInMillis:n,issuer:s,audience:a,client_id:l}=t;o||(o=0);let h=((null==n?void 0:n())||Date.now())/1e3,c=$(e).payload;if(!c.iss)throw new r("Issuer (iss) was not provided");if(c.iss!==s)throw new r(`Invalid Issuer (iss) in token: ${c.iss}`);if(!c.aud)throw new r("Audience (aud) was not provided");if(Array.isArray(c.aud)?-1===c.aud.indexOf(i?l:a||l):c.aud!==(i?l:a||l))throw new r(`Invalid Audience (aud) in token: ${c.aud}`);if(c.azp&&c.azp!==l)throw new r(`Invalid Authorized Party (azp) in token: ${c.azp}`);let d=Math.ceil(h+o),u=Math.floor(h-o);if(!c.iat)throw new r("Issued At (iat) was not provided");if(d<Number(c.iat))throw new r(`Issued At (iat) is in the future: ${c.iat}`);if(c.nbf&&d<Number(c.nbf))throw new r(`Not Before time (nbf) is in the future: ${c.nbf}`);if(!c.exp)throw new r("Expiration Time (exp) was not provided");if(Number(c.exp)<u)throw new r(`Expiration Time (exp) is in the past: ${c.exp}`)}(e,i,!0),!o.payload.sub)throw Error("No Subject (sub) present in id_token");return o.payload}catch(e){throw new a(e.message)}}(e.id_token,t.nonce,i),i.idTokenValidator&&!await i.idTokenValidator(e.id_token))return Promise.reject(new a("Id Token validation failed"));Object.keys(s).forEach(e=>{R.includes(e)||(l[e]=s[e])})}if(e.access_token){var h;if(i.requestUserInfo&&(null===(h=this.options.endpoints)||void 0===h?void 0:h.userinfo_endpoint)){let t=await this.fetchUserInfo(e.access_token);t.error||(l={...l,...t})}}return{authParams:t,user:l,...e,id_token:s,id_token_raw:e.id_token,scope:e.scope||t.scope}}async loadState(e){let t=await this.stateStore.get(e);return t?(await this.stateStore.del(e),t):Promise.reject(new s("Local state not found",e))}async fetchUserInfo(e){return this.http({method:"GET",url:`${this.options.endpoints.userinfo_endpoint}`,requestType:"json",headers:{Authorization:`Bearer ${e}`}})}monitorSession({sub:e,session_state:i}){let{client_id:o,endpoints:n}=this.options;if(!(null==n?void 0:n.check_session_iframe)){console.warn('"check_session_iframe" endpoint missing or session management is not supported by provider');return}if(!this.sessionCheckerFrame){let i=async i=>{if(i)this.emit(t.USER_LOGOUT);else{this.emit(t.SESSION_CHANGE);try{await this.silentLogin({},{});let i=await this.authStore.get("auth");if(i){var o;(null===(o=i.user)||void 0===o?void 0:o.sub)===e&&i.session_state&&this.sessionCheckerFrame.start(i.session_state)}else this.emit(t.USER_LOGOUT,null)}catch(e){this.emit(t.USER_LOGOUT);return}}};this.sessionCheckerFrame=function(e){let t,i;let{url:o,callback:n,client_id:s,checkInterval:r}=e,a=o.indexOf("/",o.indexOf("//")+2),l=o.substr(0,a),h=w(),c=()=>new Promise(e=>{window.document.body.appendChild(h),window.addEventListener("message",u,!1),h.onload=()=>{e(null)}}),d=()=>{t=null,i&&(window.clearInterval(i),i=null)},u=e=>{e.origin===l&&e.source===h.contentWindow&&("error"===e.data?(d(),n(e.data)):"changed"===e.data&&(d(),n()))};return h.setAttribute("src",o),{stop:d,start:e=>{c().then(()=>{if(e&&t!==e){d(),t=e;let o=()=>{h.contentWindow.postMessage(`${s} ${t}`,l)};o(),i=window.setInterval(o,r||2e3)}})}}}({url:n.check_session_iframe,client_id:o,callback:i,checkInterval:this.options.checkSessionInterval})}this.sessionCheckerFrame.start(i)}async onUserLogin(e,i=!1){var o;let{expires_in:n,user:s,scope:r,access_token:a,id_token:l,refresh_token:h,session_state:c,id_token_raw:d}=e;if(await this.authStore.set("auth",e),this.user=s,this.scopes=null==r?void 0:r.split(" "),this.accessToken=a,this.idToken=l,this.idTokenRaw=d,this.refreshToken=h,i||this.emit(t.USER_LOGIN,e),!(null===(o=window)||void 0===o?void 0:o.frameElement)&&(this.options.checkSession&&this.monitorSession({sub:s.sub||s.id,session_state:c}),void 0!==n&&this.options.autoSilentRenew)){let e=Number(n)-this.options.secondsToRefreshAccessTokenBeforeExp,i=()=>{this.synchronizer.CallOnce("silent-login",async()=>{try{await this.silentLogin(),this.emit(t.SILENT_RENEW_SUCCESS,null)}catch(e){this.emit(t.SILENT_RENEW_ERROR,e)}})};e>=0?this._accessTokenExpireTimer.start(e,async()=>{i()}):i()}}constructor(e){if(super(),q(this,"options",void 0),q(this,"user",void 0),q(this,"scopes",void 0),q(this,"accessToken",void 0),q(this,"refreshToken",void 0),q(this,"idToken",void 0),q(this,"idTokenRaw",void 0),q(this,"issuer_metadata",void 0),q(this,"http",void 0),q(this,"synchronizer",void 0),q(this,"stateStore",void 0),q(this,"authStore",void 0),q(this,"sessionCheckerFrame",void 0),q(this,"_accessTokenExpireTimer",void 0),q(this,"initialized",void 0),q(this,"__initializePromise",void 0),!function(e){try{let t=new URL(e);if(!["http:","https:"].includes(t.protocol)||""!==t.search||""!==t.hash)return!1;return!0}catch(e){return!1}}(e.issuer))throw new o('"issuer" must be a valid uri.');this.synchronizer=new z(btoa(e.issuer),this),this.options=A({secondsToRefreshAccessTokenBeforeExp:60,autoSilentRenew:!0,checkSession:!0,stateLength:10,nonceLength:10},e,{issuer:e.issuer.endsWith("/")?e.issuer.slice(0,-1):e.issuer}),this.http=this.options.httpClient||b,this.stateStore=this.options.stateStore||new c("pa_oidc.state."),this.authStore=this.options.authStore||new d,this.options.autoSilentRenew&&(this._accessTokenExpireTimer=new f),this.on(t.USER_LOGOUT,async()=>{this.user=void 0,this.scopes=void 0,this.accessToken=void 0,this.idToken=void 0,this.refreshToken=void 0,await this.authStore.clear()}),this.synchronizer.OnBroadcastMessage(t.USER_LOGIN,this.onUserLogin.bind(this))}}e.AuthenticationError=n,e.EventEmitter=u,e.Events=t,e.InMemoryStateStore=d,e.InteractionCancelled=l,e.InvalidIdTokenError=a,e.InvalidJWTError=r,e.LocalStorageStateStore=c,e.OIDCClient=M,e.OIDCClientError=o,e.StateNotFound=s,e.StateStore=h,e.default=function(e){return new M(e).initialize()},Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=oidc-client.min.js.map
