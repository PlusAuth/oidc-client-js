/*!
* @plusauth/oidc-client-js v1.8.0
* https://github.com/PlusAuth/oidc-client-js
* (c) 2025 @plusauth/oidc-client-js Contributors
* Released under the MIT License
*/
(function(e,t){typeof exports==`object`&&typeof module<`u`?t(exports,require(`base64-js`)):typeof define==`function`&&define.amd?define([`exports`,`base64-js`],t):(e=typeof globalThis<`u`?globalThis:e||self,t(e.PlusAuthOIDCClient={},e.base64_js))})(this,function(e,t){Object.defineProperty(e,`__esModule`,{value:!0});let n={USER_LOGOUT:`user_logout`,USER_LOGIN:`user_login`,SILENT_RENEW_SUCCESS:`silent_renew_success`,SILENT_RENEW_ERROR:`silent_renew_error`,SESSION_CHANGE:`session_change`};var r=class extends Error{constructor(e,t){super(`${e}${t&&` - ${t}`||``}`),this.name=`OIDCClientError`,this.error=e,this.error_description=t}},i=class extends r{constructor(e,t,n,r){super(e,t),this.name=`AuthenticationError`,this.state=n,this.error_uri=r}},a=class extends i{constructor(e,t){super(e),this.name=`StateNotFound`,this.state=t}},o=class extends r{constructor(e){super(e),this.name=`InvalidJWTError`,this.error_description=e}},s=class extends o{constructor(e){super(e),this.name=`InvalidIdTokenError`}},c=class extends r{constructor(e){super(e),this.name=`InteractionCancelled`}},l=class{constructor(){this.callbacks={}}once(e,t){function n(...r){this.off(e,n),t.apply(this,r)}return n.fn=t,this.on(e,n),this}on(e,t){return this.callbacks[`$${e}`]||(this.callbacks[`$${e}`]=[]),this.callbacks[`$${e}`].push(t),this}off(e,t){if(!e)return this.callbacks={},this;let n=this.callbacks[`$${e}`];if(!n)return this;if(!t)return delete this.callbacks[`$${e}`],this;for(let e=0;e<n.length;e++){let r=n[e];if(r===t||r.fn===t){n.splice(e,1);break}}return n.length===0&&delete this.callbacks[`$${e}`],this}emit(e,...t){let n=this.callbacks[`$${e}`];if(n){n=n.slice(0);for(let e=0,r=n.length;e<r;++e)n[e].apply(this,t)}return this}},u=class{constructor(e=``){this.prefix=e}},d=class extends u{constructor(...e){super(...e),this.map=new Map}clear(e){return e?(this.map.forEach((t,n)=>{t.created_at<e&&this.map.delete(n)}),Promise.resolve()):Promise.resolve(this.map.clear())}del(e){return this.map.delete(e),Promise.resolve()}get(e){return Promise.resolve(this.map.get(e)||null)}set(e,t){return this.map.set(e,t),Promise.resolve()}},f=class extends u{constructor(e=`pa_oidc.`){super(e)}get(e){return new Promise(t=>{let n=window.localStorage.getItem(this.prefix+e);t(n?JSON.parse(n):null)})}set(e,t){return new Promise(n=>{window.localStorage.setItem(this.prefix+e,JSON.stringify(t)),n()})}del(e){return new Promise(t=>{window.localStorage.removeItem(this.prefix+e),t()})}clear(e){return new Promise(t=>{let n,r=[];for(n=0;n<window.localStorage.length;n++){let e=window.localStorage.key(n);e?.substring(0,this.prefix.length)===this.prefix&&r.push(e)}for(n=0;n<r.length;n++)if(e)try{JSON.parse(window.localStorage.getItem(r[n])).created_at<e&&window.localStorage.removeItem(r[n])}catch{}else window.localStorage.removeItem(r[n]);t()})}},p=class{constructor(e=()=>Date.now()){this.now=e}start(e,t){e<=0&&(e=1);let n=this.now()/1e3+e;if(this._expiration===n&&this._timerHandle)return;this.stop(),this._expiration=n;let r=5;e<r&&(r=e),this._timerHandle=setInterval(()=>{this._expiration<=this.now()/1e3&&(this.stop(),t())},r*1e3)}stop(){this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}};let m={title:`__pa_helper__hidden`,"aria-hidden":`true`};function h(){let e=window.document.createElement(`iframe`);e.style.width=`0`,e.style.height=`0`,e.style.position=`absolute`,e.style.visibility=`hidden`,e.style.display=`none`;for(let[t,n]of Object.entries(m))e.setAttribute(t,n);return e}function g(e,t){return new Promise((n,a)=>{let o=null,s=(t.timeout||10)*1e3,c=h(),l=setTimeout(()=>{a(new r(`Timed out`)),d()},s),u=e=>{if(e.origin!==t.eventOrigin||!e.data||e.data.type!==`authorization_response`)return;let r=e.source;r&&r.close();let o=e.data.response||e.data;o.error?a(new i(o.error,o.error_description,o.state,o.error_uri)):n(e.data),clearTimeout(l),d()},d=()=>{o!=null&&clearTimeout(o),window.document.body.contains(c)&&window.document.body.removeChild(c),window.removeEventListener(`message`,u,!1)},f=()=>setTimeout(()=>{a(new r(`Could not complete silent authentication`,e)),d()},s);window.addEventListener(`message`,u,!1),window.document.body.appendChild(c),c.setAttribute(`src`,e),c.onload=()=>{o=f()}})}function _(e){let{url:t,callback:n,client_id:r,checkInterval:i}=e,a,o=t.indexOf(`/`,t.indexOf(`//`)+2),s=t.substr(0,o),c=h(),l,u=()=>new Promise(e=>{window.document.body.appendChild(c),window.addEventListener(`message`,p,!1),c.onload=()=>{e(null)}}),d=e=>{u().then(()=>{if(e&&a!==e){f(),a=e;let t=()=>{c.contentWindow.postMessage(`${r} ${a}`,s)};t(),l=window.setInterval(t,i||2e3)}})},f=()=>{a=null,l&&(window.clearInterval(l),l=null)},p=e=>{e.origin===s&&e.source===c.contentWindow&&(e.data===`error`?(f(),n(e.data)):e.data===`changed`&&(f(),n()))};return c.setAttribute(`src`,t),{stop:f,start:d}}function v(e){try{let t=new URL(e);return!(![`http:`,`https:`].includes(t.protocol)||t.search!==``||t.hash!==``)}catch{return!1}}function y(e,t=!0){if(!e)return``;let n=[];for(let t in e)e.hasOwnProperty(t)&&e[t]&&n.push(`${encodeURIComponent(t)}=${encodeURIComponent(typeof e[t]==`object`?JSON.stringify(e[t]):e[t])}`);return`${t?`?`:``}${n.join(`&`)}`}function b(e){let t={};e=e.trim().replace(/^(\?|#|&)/,``);let n=e.split(`&`);for(let e=0;e<n.length;e+=1){let r=n[e].split(`=`),i=decodeURIComponent(r.shift()),a=r.length>0?r.join(`=`):``;t[i]=decodeURIComponent(a)}return t}function x(e){return(typeof e==`string`?e:(0,t.fromByteArray)(new Uint8Array(e))).replace(/\+/g,`-`).replace(/\//g,`_`).replace(/=/g,``)}async function S(e){if(window.crypto!==void 0&&`subtle`in window.crypto){let t=await window.crypto.subtle.digest(`SHA-256`,new TextEncoder().encode(e));return x(new Uint8Array(t))}return x(C(e))}function C(e,t=!0){function n(e,t){return e>>>t|e<<32-t}let r=Math.pow,i=r(2,32),a=`length`,o,s,c=``,l=[],u=e[a]*8,d=S.h=S.h||[],f=S.k=S.k||[],p=f[a],m={};for(let e=2;p<64;e++)if(!m[e]){for(o=0;o<313;o+=e)m[o]=e;d[p]=r(e,.5)*i|0,f[p++]=r(e,1/3)*i|0}for(e+=`Â€`;e[a]%64-56;)e+=`\0`;for(o=0;o<e[a];o++){if(s=e.charCodeAt(o),s>>8)return;l[o>>2]|=s<<(3-o)%4*8}for(l[l[a]]=u/i|0,l[l[a]]=u,s=0;s<l[a];){let e=l.slice(s,s+=16),t=d;for(d=d.slice(0,8),o=0;o<64;o++){let t=e[o-15],r=e[o-2],i=d[0],a=d[4],s=d[7]+(n(a,6)^n(a,11)^n(a,25))+(a&d[5]^~a&d[6])+f[o]+(e[o]=o<16?e[o]:e[o-16]+(n(t,7)^n(t,18)^t>>>3)+e[o-7]+(n(r,17)^n(r,19)^r>>>10)|0);d=[s+((n(i,2)^n(i,13)^n(i,22))+(i&d[1]^i&d[2]^d[1]&d[2]))|0].concat(d),d[4]=d[4]+s|0}for(o=0;o<8;o++)d[o]=d[o]+t[o]|0}for(o=0;o<8;o++)for(s=3;s+1;s--){let e=d[o]>>s*8&255;c+=(e<16?0:``)+e.toString(16)}return t?btoa(c.match(/\w{2}/g).map(e=>String.fromCharCode(Number.parseInt(e,16))).join(``)):c}function w(e){let t=self.crypto||self.msCrypto,n=65536,r=new Uint8Array(e);for(let i=0;i<e;i+=n)t.getRandomValues(r.subarray(i,i+Math.min(e-i,n)));return r}function T(e){let t=``;for(;e>0;){let n=w(Math.ceil(e*256/248));for(let r=0;r<n.length&&e>0;r++){let i=n[r];i<248&&(t+=`ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789`.charAt(i%62),e--)}}return t}async function E(e){return e.length<43||e.length>128?Promise.reject(new r(`Invalid code length: ${e.length}`)):await S(e)}let D=e=>decodeURIComponent(atob(e.replace(/_/g,`/`).replace(/-/g,`+`)).split(``).map(e=>`%${`00${e.charCodeAt(0).toString(16)}`.slice(-2)}`).join(``));function O(e){try{let t=e.split(`.`);if(t.length!==3)throw Error(`Wrong JWT format`);return{header:JSON.parse(D(t[0])),payload:JSON.parse(D(t[1]))}}catch{throw new o(`Failed to parse jwt`)}}function k(e,t,n){if(!t)throw new r(`No nonce on state`);try{let r=O(e);if(t!==r.payload.nonce)throw Error(`Invalid nonce in id_token: ${r.payload.nonce}`);if(A(e,n,!0),!r.payload.sub)throw Error(`No Subject (sub) present in id_token`);return r.payload}catch(e){throw new s(e.message)}}function A(e,t,n=!1){let{clockSkew:r,currentTimeInMillis:i,issuer:a,audience:s,client_id:c}=t;r||(r=0);let l=(i?.()||Date.now())/1e3,u=O(e).payload;if(!u.iss)throw new o(`Issuer (iss) was not provided`);if(u.iss!==a)throw new o(`Invalid Issuer (iss) in token: ${u.iss}`);if(!u.aud)throw new o(`Audience (aud) was not provided`);if(Array.isArray(u.aud)?u.aud.indexOf(n?c:s||c)===-1:u.aud!==(n?c:s||c))throw new o(`Invalid Audience (aud) in token: ${u.aud}`);if(u.azp&&u.azp!==c)throw new o(`Invalid Authorized Party (azp) in token: ${u.azp}`);let d=Math.ceil(l+r),f=Math.floor(l-r);if(!u.iat)throw new o(`Issued At (iat) was not provided`);if(d<Number(u.iat))throw new o(`Issued At (iat) is in the future: ${u.iat}`);if(u.nbf&&d<Number(u.nbf))throw new o(`Not Before time (nbf) is in the future: ${u.nbf}`);if(!u.exp)throw new o(`Expiration Time (exp) was not provided`);if(Number(u.exp)<f)throw new o(`Expiration Time (exp) is in the past: ${u.exp}`);return u}let j=`iss.aud.exp.nbf.iat.jti.azp.nonce.auth_time.at_hash.c_hash.acr.amr.sub_jwk.cnf.sip_from_tag.sip_date.sip_callid.sip_cseq_num.sip_via_branch.orig.dest.mky.events.toe.txn.rph.sid.vot.vtm.attest.origid.act.scope.client_id.may_act.jcard.at_use_nbr`.split(`.`);function M(e){let t=null,n=e.headers||{};return e.method===`POST`&&(n={"Content-Type":e.requestType===`form`?`application/x-www-form-urlencoded;charset=UTF-8`:`application/json;charset=UTF-8`,...n}),e.body&&(t=e.requestType===`form`?y(e.body,!1):JSON.stringify(e.body)),new Promise((r,i)=>{fetch(e.url,{method:e.method,body:t,headers:n}).then(e=>r(e.json())).catch(i)})}function N(e){return JSON.parse(JSON.stringify(e))}function P(e,t){for(let n in t)t[n]!==void 0&&(typeof t[n]==`object`&&t[n].constructor.name===`Object`?e[n]=P(e[n]||{},t[n]):e[n]=t[n]);return e}function F(...e){return e.reduce((e,t)=>P(e||{},t),{})}let I=(e,t)=>t&&t.split(/\s+/g).filter(t=>t===e).length>0,L=(e,t)=>t&&t.split(` `).indexOf(e)>-1,R=(e,t=400,n=600)=>{let r=window.screenX+(window.innerWidth-t)/2,i=window.screenY+(window.innerHeight-n)/2;return window.open(e,`oidc-login-popup`,`left=${r},top=${i},width=${t},height=${n},resizable,scrollbars=yes,status=1`)};function z(e,t){let n=t.popup;if(n?n.location.href=e:n=R(e),!n)throw Error(`Could not open popup`);let i,a;return new Promise((e,o)=>{function s(){clearInterval(a),clearTimeout(i),window.removeEventListener(`message`,u)}let l=(t.timeout||60)*1e3;i=setTimeout(()=>{s(),o(new r(`Timed out`))},l),a=setInterval(()=>{n.closed&&(s(),o(new c(`user closed popup`)))},l),window.addEventListener(`message`,u);function u(t){if(!t.data||t.data.type!==`authorization_response`)return;s(),n.close();let i=t.data.response||t.data;i.error?o(new r(i.error,i.error_description)):e(t.data)}})}let B=`${performance.now()}:${Math.random()*1e9|0}`,V={};var H=class{constructor(e,t){this.keyPrefix=e,this.events=t}CallOnce(e,t,n=3e3){if(!e)throw`empty lockname`;if(!window.localStorage){t();return}let r=this.keyPrefix+e;localStorage.setItem(r,B),setTimeout(()=>{localStorage.getItem(r)===B&&t()},150),setTimeout(()=>{localStorage.removeItem(r)},n)}BroadcastMessageToAllTabs(e,t){try{V[e](t)}catch{}if(!window.localStorage){this.events.emit(e,t);return}let n={data:t,timeStamp:Date.now()};localStorage.setItem(`${this.keyPrefix}event${e}`,JSON.stringify(n)),setTimeout(()=>{localStorage.removeItem(`${this.keyPrefix}event${e}`)},3e3)}OnBroadcastMessage(e,t){if(V[e]=t,!window.localStorage){this.events.on(e,t);return}window.addEventListener(`storage`,n=>{n.key===`${this.keyPrefix}event${e}`&&n.newValue&&t(JSON.parse(n.newValue).data)})}},U=class extends l{constructor(e){if(super(),!v(e.issuer))throw new r(`"issuer" must be a valid uri.`);this.synchronizer=new H(btoa(e.issuer),this),this.options=F({secondsToRefreshAccessTokenBeforeExp:60,autoSilentRenew:!0,checkSession:!0,stateLength:10,nonceLength:10},e,{issuer:e.issuer.endsWith(`/`)?e.issuer.slice(0,-1):e.issuer}),this.http=this.options.httpClient||M,this.stateStore=this.options.stateStore||new f(`pa_oidc.state.`),this.authStore=this.options.authStore||new d,this.options.autoSilentRenew&&(this._accessTokenExpireTimer=new p),this.on(n.USER_LOGOUT,async()=>{this.user=void 0,this.scopes=void 0,this.accessToken=void 0,this.idToken=void 0,this.refreshToken=void 0,await this.authStore.clear()}),this.synchronizer.OnBroadcastMessage(n.USER_LOGIN,this.onUserLogin.bind(this))}async initialize(e=!0){return this.initialized?this:(this.__initializePromise||(this.__initializePromise=new Promise(async(t,i)=>{try{if(this.stateStore.init&&await this.stateStore.init(),this.authStore.init&&await this.authStore.init(),(!this.options.endpoints||Object.keys(this.options.endpoints).length===0)&&await this.fetchFromIssuer(),this.initialized=!0,e)try{window?.frameElement||await this.silentLogin()}catch(e){this.emit(n.SILENT_RENEW_ERROR,e),await this.authStore.clear()}else{let e=await this.authStore.get(`auth`);e&&await this.onUserLogin(e,!0)}t(this)}catch(e){e instanceof r?i(e):i(new r(e.message))}finally{this.__initializePromise=void 0}})),this.__initializePromise)}async login(e={},t={}){window.location.assign(await this.createAuthRequest(e,t))}async loginWithPopup(e={},t={}){let{response:r,state:i}=await z(await this.createAuthRequest({response_mode:`fragment`,...e,display:`popup`,request_type:`p`}),t),{authParams:a,localState:o}=!i||typeof i==`string`?await this.loadState(i||r.state):i,s=await this.handleAuthResponse(r,a,o),c=await this.handleTokenResult(s,a,F(this.options,a));return c.session_state=r.session_state,this.synchronizer.BroadcastMessageToAllTabs(n.USER_LOGIN,c),o}async loginCallback(e=window?.location?.href){if(!e)return Promise.reject(new r(`Url must be passed to handle login redirect`));let t;try{t=new URL(e)}catch{return Promise.reject(new r(`Invalid callback url passed: "${e}"`))}let a=b(t.search||t.hash),o=await this.loadState(a.state),{authParams:s,localState:c,request_type:l}=o;switch(e=e||window.location.href,l){case`s`:window?.frameElement&&e&&window.parent.postMessage({type:`authorization_response`,response:a,state:o},`${location.protocol}//${location.host}`);return;case`p`:window.opener&&e&&window.opener.postMessage({type:`authorization_response`,response:a,state:o},`${location.protocol}//${location.host}`);return;default:{if(a.error)return Promise.reject(new i(a.error,a.error_description));let e=await this.handleAuthResponse(a,s,c),t=await this.handleTokenResult(e,s,F(this.options,s));return t.session_state=a.session_state,this.synchronizer.BroadcastMessageToAllTabs(n.USER_LOGIN,t),c}}}async logout(e={}){if(!e.localOnly){let t=await this.authStore.get(`auth`),n=e.id_token_hint||t?.id_token_raw;window.location.assign(await this.createLogoutRequest({...e,id_token_hint:n}))}await this.authStore.clear()}async revokeToken(e,t=`access_token`,n={}){if(!this.options.endpoints.revocation_endpoint)return Promise.reject(new r(`"revocation_endpoint" doesn't exist`));let i={client_id:n.client_id||this.options.client_id,client_secret:n.client_secret||this.options.client_secret,token_type_hint:t,token:e};return this.http({method:`POST`,requestType:`form`,url:this.options.endpoints.revocation_endpoint,body:i})}async silentLogin(e={},t={}){await this.initialize(!1);let r,i={},a=await this.authStore.get(`auth`)||{},o=F({response_mode:`query`,display:`page`,prompt:`none`},this.options,e);if(o.silent_redirect_uri&&(o.redirect_uri=o.silent_redirect_uri),this.options.useRefreshToken&&a?.refresh_token)i.authParams=F(a?.authParams||{},i.authParams||{}),r=await this.exchangeRefreshToken({...o,refresh_token:a.refresh_token});else{let{response:e,state:n}=await g(await this.createAuthRequest({...o,request_type:`s`},t),{timeout:o.silentRequestTimeout,eventOrigin:window.location.origin});r=await this.handleAuthResponse(e,o,t),a.session_state=e.session_state,i=n}let s=await this.handleTokenResult(r,i.authParams,o);return s.session_state=a.session_state,this.synchronizer.BroadcastMessageToAllTabs(n.USER_LOGIN,s),i.localState}async getAccessToken(){return(await this.authStore.get(`auth`))?.access_token}async getRefreshToken(){return(await this.authStore.get(`auth`))?.refresh_token}async getIdToken(){return(await this.authStore.get(`auth`))?.id_token}async getExpiresIn(){return(await this.authStore.get(`auth`))?.expires_in}async getIdTokenRaw(){return(await this.authStore.get(`auth`))?.id_token_raw}async getScopes(){return(await this.authStore.get(`auth`))?.scope?.split(` `).filter(Boolean)}async getUser(){return(await this.authStore.get(`auth`))?.user}async isLoggedIn(e=!1){let t=!!await this.getUser();if(!t&&!e)try{return await this.silentLogin(),!0}catch{return!1}return t}async createAuthRequest(e={},t={}){this.options.endpoints?.authorization_endpoint||await this.initialize(!1);let n=Object.assign({},this.options,e);t.code_verifier=T(72);let r={client_id:n.client_id,state:n.state||T(n.stateLength),scope:n.scope,audience:n.audience,redirect_uri:n.redirect_uri,response_mode:n.response_mode,response_type:n.response_type||`code`,ui_locales:n.ui_locales,prompt:n.prompt,display:n.display,claims:n.claims,claims_locales:n.claims_locales,acr_values:n.acr_values,nonce:n.nonce,registration:n.registration,login_hint:n.login_hint,id_token_hint:n.id_token_hint,web_message_uri:n.web_message_uri,web_message_target:n.web_message_target,...n.extraParams&&n.extraParams};!r.nonce&&(I(`id_token`,r.response_type)||L(`openid`,r.scope))&&(r.nonce=T(n.nonceLength)),I(`code`,r.response_type)&&(r.code_challenge=await E(t.code_verifier),r.code_challenge_method=n.code_challenge_method||`S256`);let i=this.options.currentTimeInMillis?.()||Date.now(),a=n.fragment?`#${n.fragment}`:``,o=y(r),s=`${this.options.endpoints.authorization_endpoint}${o}${a}`;return this.stateStore.clear(i-864e5),await this.stateStore.set(r.state,N({created_at:i,authParams:r,localState:t,request_type:n.request_type})),s}async createLogoutRequest(e={}){this.options.endpoints?.end_session_endpoint||await this.fetchFromIssuer();let t=F(this.options,e),n={id_token_hint:t.id_token_hint,post_logout_redirect_uri:t.post_logout_redirect_uri,...t.extraLogoutParams||{}};return`${this.options.endpoints.end_session_endpoint}${y(n)}`}async exchangeAuthorizationCode(e){this.options.endpoints?.token_endpoint||await this.fetchFromIssuer();let{extraTokenHeaders:t,extraTokenParams:n,...r}=F(this.options,e),i={...r,...n||{},grant_type:`authorization_code`};for(let e of[`code`,`redirect_uri`,`code_verifier`,`client_id`])if(!i[e])return Promise.reject(Error(`"${e}" is required`));return this.http({url:`${this.options.endpoints.token_endpoint}`,method:`POST`,requestType:`form`,body:i,headers:t})}async exchangeRefreshToken(e){this.options.endpoints?.token_endpoint||await this.fetchFromIssuer();let{extraTokenHeaders:t,extraTokenParams:n,...r}=e,i={grant_type:`refresh_token`,client_id:this.options.client_id,client_secret:this.options.client_secret,...r,...n||{}};for(let e of[`refresh_token`,`client_id`])if(!i[e])return Promise.reject(Error(`"${e}" is required`));return this.http({url:`${this.options.endpoints.token_endpoint}`,method:`POST`,requestType:`form`,body:i,headers:t})}async fetchFromIssuer(){try{let e=`${this.options.issuer}/.well-known/openid-configuration`;this.issuer_metadata=await this.http({url:e,method:`GET`,requestType:`json`});let t={};for(let e of Object.keys(this.issuer_metadata))(e.endsWith(`_endpoint`)||e.indexOf(`_session`)>-1||e.indexOf(`_uri`)>-1)&&(t[e]=this.issuer_metadata[e]);return this.options.endpoints=t,this.issuer_metadata}catch(e){throw new r(`Loading metadata failed`,e.message)}}async handleAuthResponse(e,t,n={}){return e.code?this.exchangeAuthorizationCode({redirect_uri:t.redirect_uri,client_id:t.client_id,code_verifier:n.code_verifier,grant_type:`authorization_code`,code:e.code}):e}async handleTokenResult(e,t,n){await this.initialize(!1);let r={};if(e.error)throw new i(e.error,e.error_description);let a;if(e.id_token){if(a=await k(e.id_token,t.nonce,n),n.idTokenValidator&&!await n.idTokenValidator(e.id_token))return Promise.reject(new s(`Id Token validation failed`));Object.keys(a).forEach(e=>{j.includes(e)||(r[e]=a[e])})}if(e.access_token&&n.requestUserInfo&&this.options.endpoints?.userinfo_endpoint){let t=await this.fetchUserInfo(e.access_token);t.error||(r={...r,...t})}return{authParams:t,user:r,...e,id_token:a,id_token_raw:e.id_token,scope:e.scope===void 0?t.scope:e.scope}}async loadState(e){let t=await this.stateStore.get(e);return t?(await this.stateStore.del(e),t):Promise.reject(new a(`Local state not found`,e))}async fetchUserInfo(e){return this.http({method:`GET`,url:`${this.options.endpoints.userinfo_endpoint}`,requestType:`json`,headers:{Authorization:`Bearer ${e}`}})}monitorSession({sub:e,session_state:t}){let{client_id:r,endpoints:i}=this.options;if(!i?.check_session_iframe){console.warn(`"check_session_iframe" endpoint missing or session management is not supported by provider`);return}this.sessionCheckerFrame||(this.sessionCheckerFrame=_({url:i.check_session_iframe,client_id:r,callback:async t=>{if(t)this.emit(n.USER_LOGOUT);else{this.emit(n.SESSION_CHANGE);try{await this.silentLogin({},{});let t=await this.authStore.get(`auth`);t?t.user?.sub===e&&t.session_state&&this.sessionCheckerFrame.start(t.session_state):this.emit(n.USER_LOGOUT,null)}catch{this.emit(n.USER_LOGOUT);return}}},checkInterval:this.options.checkSessionInterval})),this.sessionCheckerFrame.start(t)}async onUserLogin(e,t=!1){let{expires_in:r,user:i,scope:a,access_token:o,id_token:s,refresh_token:c,session_state:l,id_token_raw:u}=e;if(await this.authStore.set(`auth`,e),this.user=i,this.scopes=a?.split(` `).filter(Boolean),this.accessToken=o,this.idToken=s,this.idTokenRaw=u,this.refreshToken=c,t||this.emit(n.USER_LOGIN,e),!window?.frameElement&&(this.options.checkSession&&this.monitorSession({sub:i.sub||i.id,session_state:l}),r!==void 0&&this.options.autoSilentRenew)){let e=Number(r)-this.options.secondsToRefreshAccessTokenBeforeExp,t=()=>{this.synchronizer.CallOnce(`silent-login`,async()=>{try{await this.silentLogin(),this.emit(n.SILENT_RENEW_SUCCESS,null)}catch(e){this.emit(n.SILENT_RENEW_ERROR,e)}})};e>=0?this._accessTokenExpireTimer.start(e,async()=>{t()}):t()}}};function W(e){return new U(e).initialize()}e.AuthenticationError=i,e.DefaultIframeAttributes=m,e.EventEmitter=l,e.Events=n,e.InMemoryStateStore=d,e.InteractionCancelled=c,e.InvalidIdTokenError=s,e.InvalidJWTError=o,e.LocalStorageStateStore=f,e.OIDCClient=U,e.OIDCClientError=r,e.StateNotFound=a,e.StateStore=u,e.default=W});
//# sourceMappingURL=oidc-client.min.js.map